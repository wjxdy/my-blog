name: 前后端自动打包+部署到CentOS服务器
on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      # 1. 检出代码
      - name: 检出仓库代码
        uses: actions/checkout@v4

      # 2. 前端打包（直接传dist目录）
      - name: 配置Node环境
        uses: actions/setup-node@v4
        with:
          node-version: '22.17.0'
          cache: 'npm'
          cache-dependency-path: ./My-Blog-front-end/package-lock.json

      - name: 前端打包
        working-directory: ./My-Blog-front-end
        run: |
          npm install
          npm run build
          [ -f dist/index.html ] || (echo "❌ 前端打包失败" && exit 1)
          echo "✅ 前端打包成功"

      # 3. 后端打包（直接传Jar包）
      - name: 配置Java环境
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'

      - name: 后端打包
        working-directory: ./My-Blog-Backend
        run: |
          mvn clean package -Dmaven.test.skip=true
          [ -f target/My-Blog-Backend-0.0.1-SNAPSHOT.jar ] || (echo "❌ 后端打包失败" && exit 1)
          echo "✅ 后端打包成功"

      # 4. 原生SCP传输文件（完全按你的命令格式）
      - name: 原生SCP传输前后端文件
        run: |
          # 配置SSH密钥（避免交互）
          mkdir -p ~/.ssh
          echo "${{ secrets.CENTOS_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa  # SSH要求密钥权限600
          ssh-keyscan -p ${{ secrets.CENTOS_PORT || 22 }} -H ${{ secrets.CENTOS_HOST }} >> ~/.ssh/known_hosts

          # 前端：scp -r 传dist目录（覆盖服务器旧目录）
          echo "📤 传输前端dist目录..."
          scp -i ~/.ssh/id_rsa -P ${{ secrets.CENTOS_PORT || 22 }} -r ./My-Blog-front-end/dist ${{ secrets.CENTOS_USER }}@${{ secrets.CENTOS_HOST }}:/opt/my-blog/front-end/
          echo "✅ 前端传输成功"

          # 后端：scp 传单个Jar包（直接覆盖旧包）
          echo "📤 传输后端Jar包..."
          scp -i ~/.ssh/id_rsa -P ${{ secrets.CENTOS_PORT || 22 }} ./My-Blog-Backend/target/My-Blog-Backend-0.0.1-SNAPSHOT.jar ${{ secrets.CENTOS_USER }}@${{ secrets.CENTOS_HOST }}:/opt/my-blog/backend/
          echo "✅ 后端传输成功"

      # 5. 服务器启动服务+重启Nginx
      - name: 启动服务+重启Nginx
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.CENTOS_HOST }}
          username: ${{ secrets.CENTOS_USER }}
          key: ${{ secrets.CENTOS_SSH_KEY }}
          port: ${{ secrets.CENTOS_PORT || 22 }}
          script: |
            BACKEND_PATH="/opt/my-blog/backend"
            FRONTEND_PATH="/opt/my-blog/front-end"
            JAR_NAME="My-Blog-Backend-0.0.1-SNAPSHOT.jar"
            JAR_PATH="$BACKEND_PATH/$JAR_NAME"

            # 授权（避免启动/访问权限问题）
            chmod -R 755 $BACKEND_PATH $FRONTEND_PATH/dist
            mkdir -p $BACKEND_PATH/logs

            # 停止旧服务
            kill -9 $(ps -ef | grep $JAR_PATH | grep -v grep | awk '{print $2}') >/dev/null 2>&1
            systemctl stop my-blog >/dev/null 2>&1

            # 启动新服务
            if systemctl list-unit-files --type=service | grep -q "my-blog.service"; then
              systemctl start my-blog && echo "✅ 后端服务启动成功" || echo "⚠️ systemctl启动失败，用nohup兜底"
            else
              nohup java -jar $JAR_PATH --spring.profiles.active=prod > $BACKEND_PATH/logs/app.log 2>&1 &
              echo "✅ nohup启动后端服务成功"
            fi

            # 重启Nginx
            nginx -s reload >/dev/null 2>&1 && echo "✅ Nginx重启成功" || echo "⚠️ Nginx重启失败"

      - name: 部署完成
        run: echo "🎉 全流程部署完成！"